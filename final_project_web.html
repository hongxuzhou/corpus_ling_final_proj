<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hongxu Zhou">

<title>Stylistic Variations in Neil Gaiman’s Work: A Corpus-Driven Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="final_project_web_files/libs/clipboard/clipboard.min.js"></script>
<script src="final_project_web_files/libs/quarto-html/quarto.js"></script>
<script src="final_project_web_files/libs/quarto-html/popper.min.js"></script>
<script src="final_project_web_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="final_project_web_files/libs/quarto-html/anchor.min.js"></script>
<link href="final_project_web_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="final_project_web_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="final_project_web_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="final_project_web_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="final_project_web_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#loading-necessary-packages" id="toc-loading-necessary-packages" class="nav-link" data-scroll-target="#loading-necessary-packages"><span class="header-section-number">1.1</span> Loading necessary packages</a></li>
  </ul></li>
  <li><a href="#corpus" id="toc-corpus" class="nav-link" data-scroll-target="#corpus"><span class="header-section-number">2</span> Corpus</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis"><span class="header-section-number">3</span> Analysis</a>
  <ul class="collapse">
  <li><a href="#lexical-level" id="toc-lexical-level" class="nav-link" data-scroll-target="#lexical-level"><span class="header-section-number">3.1</span> lexical level</a></li>
  <li><a href="#sentence-level" id="toc-sentence-level" class="nav-link" data-scroll-target="#sentence-level"><span class="header-section-number">3.2</span> Sentence Level</a>
  <ul class="collapse">
  <li><a href="#discourse-level" id="toc-discourse-level" class="nav-link" data-scroll-target="#discourse-level"><span class="header-section-number">3.2.1</span> Discourse level</a></li>
  <li><a href="#integrated-analysis" id="toc-integrated-analysis" class="nav-link" data-scroll-target="#integrated-analysis"><span class="header-section-number">3.2.2</span> Integrated Analysis</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-reference" id="toc-sec-reference" class="nav-link" data-scroll-target="#sec-reference"><span class="header-section-number">4</span> Reference</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><span class="header-section-number">5</span> </a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Stylistic Variations in Neil Gaiman’s Work: A Corpus-Driven Analysis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Hongxu Zhou </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>As a prominent contemporary author, Neil Gaiman has produced a substantial body of work spanning diverse genres and targeting audiences ranging from children to adults. This project employs corpus-driven methods to analyse potential stylistic variations in Gaiman’s writing that may distinguish works intended for different reader demographics. Through systematic linguistic analysis, the study aims to identify and characterise textual features that differentiate Gaiman’s writing across audience-targeted works.</p>
<section id="loading-necessary-packages" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="loading-necessary-packages"><span class="header-section-number">1.1</span> Loading necessary packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)      </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.2     ✔ tibble    3.2.1
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.0.4     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)           </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>here() starts at /Users/hongxuzhou/corpus_linguistics/final_project</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quanteda)       </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Package version: 4.2.0
Unicode version: 14.0
ICU version: 71.1
Parallel computing: disabled
See https://quanteda.io for tutorials and examples.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quanteda.textstats)  </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sentimentr)     </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wordcloud)      </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: RColorBrewer</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)        </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)     </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'gridExtra'

The following object is masked from 'package:dplyr':

    combine</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'scales'

The following object is masked from 'package:purrr':

    discard

The following object is masked from 'package:readr':

    col_factor</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggridges)      </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stopwords)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(udpipe)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel) </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Welcome! Want to learn more? See two factoextra-related books at https://goo.gl/ve3WBa</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the corpus</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>gaiman_corpus <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">here</span>(<span class="st">"corpora"</span>, <span class="st">"gaiman_corpus_complete.rds"</span>))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore the structure</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(gaiman_corpus, <span class="at">max.level =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ metadata      :List of 2
 $ document_level: tibble [154 × 7] (S3: tbl_df/tbl/data.frame)
 $ sentence_level: tibble [60,127 × 9] (S3: tbl_df/tbl/data.frame)
 $ token_level   : tibble [728,034 × 8] (S3: tbl_df/tbl/data.frame)
 $ vocabulary    : tibble [28,968 × 6] (S3: tbl_df/tbl/data.frame)</code></pre>
</div>
</div>
<p>The corpus contains three levels of the texts: document-level (tokenised by chapter); sentence-level (tokenised by sentence-end punctuation); and token-level (tokenised by word).<br>
To accelerate the calculation and analysis, some basic statistical features are calculated beforehand and added to the corpus as the layers of Metadata and Vocabulary.</p>
</section>
</section>
<section id="corpus" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Corpus</h1>
<p>This study built a specialised corpus comprising ten books by Neil Gaiman, selected to represent the author’s rage across audience demographics. The ten books are:</p>
<table class="caption-top table">
<caption>Books in Gaiman Corpus</caption>
<thead>
<tr class="header">
<th>Book Title</th>
<th>Abbr.</th>
<th>Goodreads Genre Tags</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>American Gods</td>
<td>AG</td>
<td>Adult</td>
</tr>
<tr class="even">
<td>Anansi Boys</td>
<td>AB</td>
<td>Adult</td>
</tr>
<tr class="odd">
<td>Neverwhere</td>
<td>NW</td>
<td>Adult; Young-Adult</td>
</tr>
<tr class="even">
<td>Smoke and Mirrors</td>
<td>SM</td>
<td>Adult; Young-Adult</td>
</tr>
<tr class="odd">
<td>The Ocean at the End of the Lane</td>
<td>OCEAN</td>
<td>Young-Adult; Adult</td>
</tr>
<tr class="even">
<td>Coraline</td>
<td>CL</td>
<td>Young-Adult; Children;</td>
</tr>
<tr class="odd">
<td>The Graveyard Book</td>
<td>TGB</td>
<td>Young-Adult; Children</td>
</tr>
<tr class="even">
<td>Fortunately, the Milk</td>
<td>FTM</td>
<td>Children, Young-Adult</td>
</tr>
<tr class="odd">
<td>Odd the the Frost Giants</td>
<td>OFG</td>
<td>Children, Young-Adult</td>
</tr>
<tr class="even">
<td>Stardust</td>
<td>ST</td>
<td>Young Adult, Adult</td>
</tr>
</tbody>
</table>
<p>They span Gaiman’s career and represent various genres within his oeuvre. Therefore, this corpus is a balanced representation for analysis of potential stylistic variations.</p>
<p>Each books was obtained in EPUB format, which preserved textual content while maintaining structural elements that enables programming analysis. The <code>epubr</code> package <span class="citation" data-cites="leonawicz2025">(<a href="#ref-leonawicz2025" role="doc-biblioref">Leonawicz, 2025</a>)</span> was used to extract and parse content from these books while preserving metadata and chapter boundaries.</p>
<p>The the cop was designed with the multi-tired structure to accelerate analysis at different levels of linguistic granularity:</p>
<ol type="1">
<li><strong>Document-level</strong>: Each chapter/single story constitute a document. This layer of corpus keeps narrative unites as defined by the author, and so enables analysis of chapter-level stylistic patterns and narrative structure.</li>
<li><strong>Sentence-level</strong>: The text is segmented into individual sentences using the <code>tokenizers</code> package <span class="citation" data-cites="mullen">(<a href="#ref-mullen" role="doc-biblioref">Mullen, n.d.</a>)</span>, which applies rule-based sentence boundary disambiguation. This intermediate level allows for analysis of syntactic patterns and sentence complexity.</li>
<li><strong>Token-level</strong>: Individual words are extracted for lexical analysis. Tokens maintain references to their source sentences and documents, enabling multi-level analysis.</li>
</ol>
<p>Additionally, two supplementary components are created:</p>
<ol type="1">
<li><strong>Metadata layer</strong>: It contains corpus-level statistics (total size, unique vocabulary) and book-level metadata (lexical diversity, average sentence length).</li>
<li><strong>Vocabulary layer</strong>: It provides frequency and distribution for each unique token in the corpus.</li>
</ol>
<p>As a result, the corpus contains 711,385 words across 154 documents (chapter/story), with an average of 15.4 chapters per book. The corpus contains 60,127 sentences with an average length of 12.3 words per sentence. The vocabulary size (type) is 28, 968.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract book-level metadata</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>book_metadata <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>metadata<span class="sc">$</span>book_level</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display basic statistics about the corpus </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>corpus_summary <span class="ot">&lt;-</span> book_metadata <span class="sc">|&gt;</span> </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_books =</span> <span class="fu">n</span>(),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_words =</span> <span class="fu">sum</span>(total_words),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_words_per_book =</span> <span class="fu">mean</span>(total_words),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_chapters =</span> <span class="fu">mean</span>(chapters),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_sentences =</span> <span class="fu">mean</span>(sentences),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_sentence_length =</span> <span class="fu">mean</span>(avg_sentence_length),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_lexical_diversity =</span> <span class="fu">mean</span>(lexical_diversity)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(corpus_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  total_books total_words avg_words_per_book avg_chapters avg_sentences
        &lt;int&gt;       &lt;int&gt;              &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;
1          10      711385             711385         15.4         6013.
# ℹ 2 more variables: avg_sentence_length &lt;dbl&gt;, avg_lexical_diversity &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="analysis" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Analysis</h1>
<section id="lexical-level" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="lexical-level"><span class="header-section-number">3.1</span> lexical level</h2>
<p>The lexical analysis examines word-level patterns that might distinguish text for different audience groups. I analysed word length distribution, lexical diversity, and distinctive vocabulary to investigate potential stylistic variations.</p>
<section id="word-length-distribution" class="level4" data-number="3.1.0.1">
<h4 data-number="3.1.0.1" class="anchored" data-anchor-id="word-length-distribution"><span class="header-section-number">3.1.0.1</span> Word Length Distribution</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate word length for all tokens</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>token_length <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>token_level <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate character length of each token </span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">word_length =</span> <span class="fu">nchar</span>(token))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># With token length, calculate word lengh by book</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>word_lengh_stats <span class="ot">&lt;-</span> token_length <span class="sc">|&gt;</span> </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span> </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_length =</span> <span class="fu">mean</span>(word_length),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_length =</span> <span class="fu">median</span>(word_length),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_length =</span> <span class="fu">sd</span>(word_length),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># further check the percentage of words by length </span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">short_word_pct =</span> <span class="fu">mean</span>(word_length <span class="sc">&lt;=</span> <span class="dv">4</span>) <span class="sc">*</span> <span class="dv">100</span>, <span class="co"># 1-4 words = short</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">medium_word_pct =</span> <span class="fu">mean</span>(word_length <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">&amp;</span> word_length <span class="sc">&lt;=</span> <span class="dv">8</span>)<span class="sc">*</span> <span class="dv">100</span>, <span class="co"># 4 - 8 = medium</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">long_word_pct =</span> <span class="fu">mean</span>(word_length <span class="sc">&gt;</span><span class="dv">8</span>)<span class="sc">*</span><span class="dv">100</span>, <span class="co"># 9+ words are long</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_length))</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(word_lengh_stats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 7
   book_id avg_length median_length sd_length short_word_pct medium_word_pct
   &lt;chr&gt;        &lt;dbl&gt;         &lt;dbl&gt;     &lt;dbl&gt;          &lt;dbl&gt;           &lt;dbl&gt;
 1 NW            4.34             4      2.20           62.7            32.3
 2 CL            4.30             4      2.16           64.7            31.0
 3 SM            4.27             4      2.26           63.8            30.9
 4 AB            4.26             4      2.18           64.5            30.8
 5 ST            4.23             4      2.13           65.1            30.6
 6 TGB           4.17             4      2.08           66.5            29.2
 7 AG            4.17             4      2.03           65.7            30.3
 8 FTM           4.13             4      2.14           66.5            28.7
 9 OFG           4.07             4      1.95           68.0            28.8
10 OCEAN         4.01             4      2.00           68.0            28.8
# ℹ 1 more variable: long_word_pct &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>word_lengh_dist <span class="ot">&lt;-</span> token_length <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count occurrences of each word length in each book </span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(book_id, word_length) <span class="sc">|&gt;</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by book to calculate percentages </span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percentage =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># start vis</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> word_length, </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> percentage,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> book_id,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">group =</span> book_id)) <span class="sc">+</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> <span class="co"># no more "size", update to linewidth</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Word Length Distribution by Book"</span>, </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of words at each character length"</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Word Length (by character)"</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> <span class="st">"Percentage of books"</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Book"</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">+</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(word_lengh_dist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-word_length_vis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-word_length_vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-word_length_vis-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-word_length_vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Word Length Distribution by Book
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="lexical-diversity" class="level4" data-number="3.1.0.2">
<h4 data-number="3.1.0.2" class="anchored" data-anchor-id="lexical-diversity"><span class="header-section-number">3.1.0.2</span> Lexical Diversity</h4>
<p>Lexical diversity is measured using the type-token ratio (TTR), which represents vocabulary richness:</p>
<p><span class="math display">\[
Lexical\quad Diversity = \frac {Number \quad of \quad Unique \quad Words} {Total \quad Word \quad Count}
\]</span></p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ttr_visualisation" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ttr_visualisation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-ttr_visualisation-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ttr_visualisation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Lexical Diversity by Book
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="word-frequency" class="level4" data-number="3.1.0.3">
<h4 data-number="3.1.0.3" class="anchored" data-anchor-id="word-frequency"><span class="header-section-number">3.1.0.3</span> Word Frequency</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a corpus from the document level data</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>quanteda_corpus <span class="ot">&lt;-</span> <span class="fu">corpus</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  gaiman_corpus<span class="sc">$</span>document_level<span class="sc">$</span>text,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">docnames =</span> gaiman_corpus<span class="sc">$</span>document_level<span class="sc">$</span>doc_id</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add document variables for grouping</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">docvars</span>(quanteda_corpus, <span class="st">"book_id"</span>) <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>document_level<span class="sc">$</span>book_id</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">docvars</span>(quanteda_corpus, <span class="st">"title"</span>) <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>document_level<span class="sc">$</span>title</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="fu">docvars</span>(quanteda_corpus, <span class="st">"chapter_num"</span>) <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>document_level<span class="sc">$</span>chapter_num</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="keyword-analysis" class="level4" data-number="3.1.0.4">
<h4 data-number="3.1.0.4" class="anchored" data-anchor-id="keyword-analysis"><span class="header-section-number">3.1.0.4</span> Keyword analysis</h4>
<p>To identify vocabulary patterns distinctive to each book, I use a log-odds ratio analysis to compare word frequencies within each book against the rest of the corpus.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vis top 10 keywords for each book</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>top_keywords_plot <span class="ot">&lt;-</span> keywords_df <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tidytext<span class="sc">::</span><span class="fu">reorder_within</span>(term, log_odds, book_id), </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> log_odds, </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> book_id)) <span class="sc">+</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> book_id, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  upstartr<span class="sc">::</span><span class="fu">scale_x_reordered</span>() <span class="sc">+</span>  <span class="co"># Required for reorder_within</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Top 10 Distinctive Words by Book",</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Based on log odds ratio compared to other books"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Term"</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Log Odds Ratio"</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(top_keywords_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-log_off_keywords" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-log_off_keywords-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-log_off_keywords-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-log_off_keywords-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Top 10 Keywords by Book
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sentence-level" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sentence-level"><span class="header-section-number">3.2</span> Sentence Level</h2>
<p>The sentence level analysis provides deeper insights into the stylistic variation in the corpus than word-level features alone. Based on sentence structure analysis, I examine complexity, readability and content characteristics across different works.</p>
<section id="sentence-length-analysis" class="level4" data-number="3.2.0.1">
<h4 data-number="3.2.0.1" class="anchored" data-anchor-id="sentence-length-analysis"><span class="header-section-number">3.2.0.1</span> Sentence length analysis</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare sentence data</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>sentence_data <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>sentence_level <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(book_id, title, chapter_num, sentence_id, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate sentence length statistics</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sentence_length_stats <span class="ot">&lt;-</span> sentence_data <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add sentence length in words</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sentence_length =</span> <span class="fu">sapply</span>(<span class="fu">strsplit</span>(text, <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>), length)) <span class="sc">|&gt;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by book - no need ungroup, no effect</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate statistics</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_length =</span> <span class="fu">mean</span>(sentence_length),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_length =</span> <span class="fu">median</span>(sentence_length),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_length =</span> <span class="fu">sd</span>(sentence_length),</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_length =</span> <span class="fu">min</span>(sentence_length),</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_length =</span> <span class="fu">max</span>(sentence_length),</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">short_sent_pct =</span> <span class="fu">mean</span>(sentence_length <span class="sc">&lt;=</span> <span class="dv">5</span>) <span class="sc">*</span> <span class="dv">100</span>,  <span class="co"># Percentage of short sentences</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">long_sent_pct =</span> <span class="fu">mean</span>(sentence_length <span class="sc">&gt;</span> <span class="dv">20</span>) <span class="sc">*</span> <span class="dv">100</span>    <span class="co"># Percentage of long sentences</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_length))</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Vis sentence length distribution</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>sentence_length_vis <span class="ot">&lt;-</span> sentence_data <span class="sc">|&gt;</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add sentence length in words</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sentence_length =</span> <span class="fu">sapply</span>(<span class="fu">strsplit</span>(text, <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span>), length)) <span class="sc">|&gt;</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove extreme outliers for better visualization</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sentence_length <span class="sc">&lt;=</span> <span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sentence_length, <span class="at">y =</span> book_id, <span class="at">fill =</span> book_id)) <span class="sc">+</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density_ridges</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">scale =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Sentence Length Distribution by Book",</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Ridgeline plot of word counts per sentence"</span>,</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Words per Sentence"</span>,</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Book"</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sentence_length_vis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 1.35</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-sentent_length_dist_vis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sentent_length_dist_vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-sentent_length_dist_vis-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sentent_length_dist_vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Sentence Length Distribution by Book
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="syntactic-complexity" class="level4" data-number="3.2.0.2">
<h4 data-number="3.2.0.2" class="anchored" data-anchor-id="syntactic-complexity"><span class="header-section-number">3.2.0.2</span> Syntactic Complexity</h4>
<p>Syntactic complexity is measured through dependency parsing, which captures the relationships between words in a sentence. Mean dependency length (MDL) is a method that calculates the average distance between syntactically related words. It represents language comprehension difficulty <span class="citation" data-cites="haitaoliu2008">(<a href="#ref-haitaoliu2008" role="doc-biblioref">Haitao Liu, 2008</a>)</span>. Higher MDL values indicate more complex sentence structures, for example, with embedded or non-adjacent relationships.</p>
<p>This analysis sampled 100 sentences from each book and parsed them using the Universal Dependency framework provided by <code>udpipe</code> <span class="citation" data-cites="straka2016">(<a href="#ref-straka2016" role="doc-biblioref">Straka et al., 2016</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Function to calculate mean dependency length for parsed text</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>calculate_mean_dep_length <span class="ot">&lt;-</span> <span class="cf">function</span>(parsed_data) {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each sentence, calculate dependency lengths</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  parsed_data <span class="sc">|&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter out root nodes and punctuation</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(head_token_id <span class="sc">!=</span> <span class="dv">0</span>, upos <span class="sc">!=</span> <span class="st">"PUNCT"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate absolute distance between each word and its head</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Convert IDs to numeric and calculate distance</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">token_id_num =</span> <span class="fu">as.numeric</span>(token_id),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">head_id_num =</span> <span class="fu">as.numeric</span>(head_token_id),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Absolute difference is the dependency length</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">dep_length =</span> <span class="fu">abs</span>(token_id_num <span class="sc">-</span> head_id_num)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate mean dependency length</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_dep_length =</span> <span class="fu">mean</span>(dep_length, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">median_dep_length =</span> <span class="fu">median</span>(dep_length, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_dep_length =</span> <span class="fu">max</span>(dep_length, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">deps_analyzed =</span> <span class="fu">n</span>(),</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Process a sample of text from each book to calculate dependency lengths</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="co"># This avoids processing the entire corpus which could be time-consuming</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>) <span class="co"># For reproducibility in sampling</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>sample_size <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># Sample 100 sentences per book for analysis</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Get sample sentences from each book - FIXED version</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>sampled_sentences <span class="ot">&lt;-</span> sentence_data <span class="sc">|&gt;</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Split by book_id</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use group_modify to properly access group size</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span>{</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the minimum of sample_size or actual group size</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    sample_size_to_use <span class="ot">&lt;-</span> <span class="fu">min</span>(sample_size, <span class="fu">nrow</span>(.x))</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample that many rows</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(.x, <span class="at">n =</span> sample_size_to_use)</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">|&gt;</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a unique identifier for each sampled sentence</span></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>sampled_sentences <span class="ot">&lt;-</span> sampled_sentences <span class="sc">|&gt;</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sample_id =</span> <span class="fu">paste0</span>(book_id, <span class="st">"_"</span>, <span class="fu">row_number</span>()))</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialise dependency parsing model</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: everytime it runs, it downloads the model again </span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>dep_model <span class="ot">&lt;-</span> <span class="fu">udpipe_download_model</span>(<span class="at">language =</span> <span class="st">"english-ewt"</span>, <span class="at">model_dir =</span> <span class="fu">getwd</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading udpipe model from https://raw.githubusercontent.com/jwijffels/udpipe.models.ud.2.5/master/inst/udpipe-ud-2.5-191206/english-ewt-ud-2.5-191206.udpipe to /Users/hongxuzhou/corpus_linguistics/final_project/english-ewt-ud-2.5-191206.udpipe</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - This model has been trained on version 2.5 of data from https://universaldependencies.org</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - The model is distributed under the CC-BY-SA-NC license: https://creativecommons.org/licenses/by-nc-sa/4.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - Visit https://github.com/jwijffels/udpipe.models.ud.2.5 for model license details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> - For a list of all models and their licenses (most models you can download with this package have either a CC-BY-SA or a CC-BY-SA-NC license) read the documentation at ?udpipe_download_model. For building your own models: visit the documentation by typing vignette('udpipe-train', package = 'udpipe')</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading finished, model stored at '/Users/hongxuzhou/corpus_linguistics/final_project/english-ewt-ud-2.5-191206.udpipe'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>ud_model <span class="ot">&lt;-</span> <span class="fu">udpipe_load_model</span>(dep_model<span class="sc">$</span>file_model)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Process the sample sentences with udpipe for dependency parsing</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the sample_id as doc_id to maintain uniqueness</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>parsed_samples <span class="ot">&lt;-</span> <span class="fu">udpipe</span>(</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> sampled_sentences<span class="sc">$</span>text, </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> ud_model,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">doc_id =</span> sampled_sentences<span class="sc">$</span>sample_id,  <span class="co"># Use our unique sample_id</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel.cores =</span> <span class="dv">1</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping between sample_id and book_id</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>sample_book_mapping <span class="ot">&lt;-</span> sampled_sentences <span class="sc">|&gt;</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sample_id, book_id, title) <span class="sc">|&gt;</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Calculate mean dependency length for each sentence, then aggregate by book</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>sentence_dependency_stats <span class="ot">&lt;-</span> parsed_samples <span class="sc">|&gt;</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by doc_id (which is our sample_id)</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(doc_id) <span class="sc">|&gt;</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate dependency stats for each sentence</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span><span class="fu">calculate_mean_dep_length</span>(.x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
There was 1 warning in `summarize()`.
ℹ In argument: `max_dep_length = max(dep_length, na.rm = TRUE)`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join with our mapping to get book information</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>book_dependency_stats <span class="ot">&lt;-</span> sentence_dependency_stats <span class="sc">|&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join with mapping to get book_id</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(sample_book_mapping, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"doc_id"</span> <span class="ot">=</span> <span class="st">"sample_id"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by book to aggregate sentence-level stats</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id, title) <span class="sc">|&gt;</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate book-level averages</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_dep_length =</span> <span class="fu">mean</span>(mean_dep_length, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_dep_length =</span> <span class="fu">mean</span>(median_dep_length, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_dep_length =</span> <span class="fu">max</span>(max_dep_length, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sentences_analyzed =</span> <span class="fu">n</span>(),</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Create vis of mean dependency length</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>dep_length_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(book_dependency_stats,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by mean dependency length</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(book_id, mean_dep_length),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> mean_dep_length)) <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"#5D93E1"</span>) <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add error bars showing variability</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">ymin =</span> mean_dep_length <span class="sc">-</span> median_dep_length<span class="sc">/</span><span class="dv">4</span>, </span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">ymax =</span> mean_dep_length <span class="sc">+</span> median_dep_length<span class="sc">/</span><span class="dv">4</span>),</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">"#2C528C"</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Syntactic Complexity in Gaiman's Works",</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Mean dependency length (average distance between related words)"</span>,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Book"</span>,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Dependency Length"</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Find illustrative examples of short and long dependencies</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="co"># better be extreme</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>parsed_with_dep_length <span class="ot">&lt;-</span> parsed_samples <span class="sc">|&gt;</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate dependency length for each token</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">token_id_num =</span> <span class="fu">as.numeric</span>(token_id),</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">head_id_num =</span> <span class="fu">as.numeric</span>(head_token_id),</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">dep_length =</span> <span class="fu">abs</span>(token_id_num <span class="sc">-</span> head_id_num)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate to get max dependency length in each sentence</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>sentence_max_deps <span class="ot">&lt;-</span> parsed_with_dep_length <span class="sc">|&gt;</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(doc_id, sentence_id) <span class="sc">|&gt;</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_dep =</span> <span class="fu">max</span>(dep_length[upos <span class="sc">!=</span> <span class="st">"PUNCT"</span> <span class="sc">&amp;</span> head_token_id <span class="sc">!=</span> <span class="st">"0"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">sentence_text =</span> <span class="fu">first</span>(sentence),</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove potential NA/Inf values from empty sentences</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(max_dep))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 47 warnings in `summarize()`.
The first warning was:
ℹ In argument: `max_dep = max(dep_length[upos != "PUNCT" &amp; head_token_id !=
  "0"], na.rm = TRUE)`.
ℹ In group 9: `doc_id = "AB_16"` `sentence_id = 1`.
Caused by warning in `max()`:
! no non-missing arguments to max; returning -Inf
ℹ Run `dplyr::last_dplyr_warnings()` to see the 46 remaining warnings.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find better examples</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>short_example <span class="ot">&lt;-</span> sentence_max_deps <span class="sc">|&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(max_dep <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> max_dep <span class="sc">&lt;=</span> <span class="dv">3</span>) <span class="sc">|&gt;</span>  <span class="co"># Not too trivial, but still simple</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">nchar</span>(sentence_text) <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">|&gt;</span>    <span class="co"># Ensure it's a real sentence</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(max_dep) <span class="sc">|&gt;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>long_example <span class="ot">&lt;-</span> sentence_max_deps <span class="sc">|&gt;</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(max_dep <span class="sc">&gt;=</span> <span class="dv">7</span>) <span class="sc">|&gt;</span>                <span class="co"># Clearly complex</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(max_dep)) <span class="sc">|&gt;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Join with book information for examples</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>example_sentences <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  short_example <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Short dependency"</span>),</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  long_example <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Long dependency"</span>)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(sample_book_mapping, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"doc_id"</span> <span class="ot">=</span> <span class="st">"sample_id"</span>))</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dep_length_plot)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Print example sentences with book sources</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Example sentences illustrating dependency length:</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Example sentences illustrating dependency length:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># not very helpful and takes too much space, not use</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(example_sentences)) {</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste0</span>(example_sentences<span class="sc">$</span>type[i], <span class="st">" (max = "</span>, </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">round</span>(example_sentences<span class="sc">$</span>max_dep[i], <span class="dv">1</span>), </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">") from "</span>, example_sentences<span class="sc">$</span>title[i], <span class="st">":</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(example_sentences<span class="sc">$</span>sentence_text[i], <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Short dependency (max = 2) from Anansi Boys:
I may go to Africa. 

Long dependency (max = 106) from Odd and the Frost Giants:
And, somehow, he had got himself home, hauling his father's heavy axe with him, for metal was rare in those hills and axes needed to be bartered or stolen, and he could not have left it to rust.So two years passed, and Odd's mother married Fat Elfred, who was amiable enough when he had not been drinking, but he already had four sons and three daughters from a previous marriage (his wife had been struck by lightning), and he had no time for a crippled stepson, so Odd spent more and more time out in the great woods.Odd loved the spring, when the waterfalls began to course down the valleys and the woodland was covered with flowers. </code></pre>
</div>
<div class="cell-output-display">
<div id="fig-ud_vis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ud_vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-ud_vis-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ud_vis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Syntactic Complexity in Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="readability-analysis" class="level4" data-number="3.2.0.3">
<h4 data-number="3.2.0.3" class="anchored" data-anchor-id="readability-analysis"><span class="header-section-number">3.2.0.3</span> Readability Analysis</h4>
<p>The Flesch-Kincaid Grade Level scores provide standardised readability measurements based on word and sentence characteristics. <a href="#fig-readability_score" class="quarto-xref">Figure&nbsp;6</a> shows these scores across Gaiman’s works calculated by <code>quanteda</code> <span class="citation" data-cites="benoit2018">(<a href="#ref-benoit2018" role="doc-biblioref">Benoit et al., 2018</a>)</span> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Focus solely on Flesch-Kincaid Grade Level without imposing age categories</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Calculate readability scores for each book</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>book_texts <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>document_level <span class="sc">|&gt;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">text =</span> <span class="fu">paste</span>(text, <span class="at">collapse =</span> <span class="st">" "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Use quanteda for readability calculations</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>readability_scores <span class="ot">&lt;-</span> <span class="fu">textstat_readability</span>(</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  book_texts<span class="sc">$</span>text,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">c</span>(<span class="st">"Flesch.Kincaid"</span>)  <span class="co"># Focus on just this measure</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>readability_scores<span class="sc">$</span>book_id <span class="ot">&lt;-</span> book_texts<span class="sc">$</span>book_id</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Join with book information</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>readability_data <span class="ot">&lt;-</span> readability_scores <span class="sc">|&gt;</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get book information (title only)</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    gaiman_corpus<span class="sc">$</span>metadata<span class="sc">$</span>book_level <span class="sc">|&gt;</span> </span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(book_id, title), </span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"book_id"</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Create a cleaner, data-driven vis</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>readability_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(readability_data,</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by Flesch-Kincaid score (reading difficulty)</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(book_id, Flesch.Kincaid),</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Flesch.Kincaid)) <span class="sc">+</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use a gradient color reflecting complexity, but not imposing categories</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Flesch.Kincaid)) <span class="sc">+</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"#E3F2FD"</span>, <span class="at">high =</span> <span class="st">"#1565C0"</span>) <span class="sc">+</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add labeled reference lines for grade level interpretation</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">12</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray60"</span>) <span class="sc">+</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="fl">5.2</span>, <span class="at">label =</span> <span class="st">"5th Grade"</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="fl">8.2</span>, <span class="at">label =</span> <span class="st">"8th Grade"</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="fl">12.2</span>, <span class="at">label =</span> <span class="st">"12th Grade"</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Reading Difficulty of Gaiman's Works",</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Flesch-Kincaid Grade Level (higher = more difficult reading)"</span>,</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Book"</span>,</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Reading Grade Level"</span>,</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Grade Level"</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Add book titles to the plot for clearer identification</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>readability_plot <span class="ot">&lt;-</span> readability_plot <span class="sc">+</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add book titles as text labels</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> title, <span class="at">y =</span> <span class="fl">0.5</span>),</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">"orange"</span> <span class="co"># easier to see</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the visualization</span></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(readability_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-readability_score" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-readability_score-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-readability_score-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-readability_score-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Reading Difficulty of Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="profanity-analysis" class="level4" data-number="3.2.0.4">
<h4 data-number="3.2.0.4" class="anchored" data-anchor-id="profanity-analysis"><span class="header-section-number">3.2.0.4</span> Profanity Analysis</h4>
<p>A dictionary-based approach was used to detect and categorise profanity across words.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Define categorized profanity dictionaries</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Expanded lists with more comprehensive coverage</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># all swear generated by chatgpt</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>mild_profanity <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"damn"</span>, <span class="st">"darn"</span>, <span class="st">"hell"</span>, <span class="st">"crap"</span>, <span class="st">"suck"</span>, <span class="st">"stupid"</span>, <span class="st">"idiot"</span>, <span class="st">"dumb"</span>, </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"moron"</span>, <span class="st">"fool"</span>, <span class="st">"jerk"</span>, <span class="st">"dork"</span>, <span class="st">"heck"</span>, <span class="st">"gosh"</span>, <span class="st">"jeez"</span>, <span class="st">"Christ"</span>, </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"God"</span>, <span class="st">"Jesus"</span>, <span class="st">"bloody"</span>, <span class="st">"blast"</span>, <span class="st">"drat"</span>, <span class="st">"freaking"</span>, <span class="st">"frigging"</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"poop"</span>, <span class="st">"butt"</span>, <span class="st">"arse"</span>, <span class="st">"bollocks"</span>, <span class="st">"turd"</span>, <span class="st">"bum"</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>moderate_profanity <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ass"</span>, <span class="st">"asshole"</span>, <span class="st">"bastard"</span>, <span class="st">"shit"</span>, <span class="st">"bullshit"</span>, <span class="st">"piss"</span>, </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"screw"</span>, <span class="st">"screwed"</span>, <span class="st">"dick"</span>, <span class="st">"cock"</span>, <span class="st">"prick"</span>, <span class="st">"slut"</span>, <span class="st">"whore"</span>, </span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wanker"</span>, <span class="st">"tosser"</span>, <span class="st">"twat"</span>, <span class="st">"crap"</span>, <span class="st">"balls"</span>, <span class="st">"nuts"</span>, <span class="st">"pissed"</span>, </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fart"</span>, <span class="st">"jackass"</span>, <span class="st">"douche"</span>, <span class="st">"douchebag"</span>, <span class="st">"tits"</span>, <span class="st">"boobs"</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>strong_profanity <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fuck"</span>, <span class="st">"fucked"</span>, <span class="st">"fucker"</span>, <span class="st">"fucking"</span>, <span class="st">"motherfucker"</span>, <span class="st">"motherfucking"</span>,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cunt"</span>, <span class="st">"pussy"</span>, <span class="st">"cock"</span>, <span class="st">"bitch"</span>, <span class="st">"cum"</span>, <span class="st">"jizz"</span>, <span class="st">"nigger"</span>, <span class="st">"faggot"</span>, </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fag"</span>, <span class="st">"spic"</span>, <span class="st">"chink"</span>, <span class="st">"kike"</span>, <span class="st">"retard"</span>, <span class="st">"whore"</span>, <span class="st">"slut"</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all for overall profanity detection</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>all_profanity <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(mild_profanity, moderate_profanity, strong_profanity))</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Prepare sentence-level data</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>sentence_data <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>sentence_level <span class="sc">|&gt;</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(book_id, title, sentence_id, text)</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Apply overall profanity detection </span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>profanity_results <span class="ot">&lt;-</span> <span class="fu">profanity_by</span>(</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">text.var =</span> sentence_data<span class="sc">$</span>text,</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> sentence_data<span class="sc">$</span>book_id,</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">profanity_list =</span> all_profanity</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Each time `profanity_by` is run it has to do sentence boundary disambiguation when a
raw `character` vector is passed to `text.var`. This may be costly of time and
memory.  It is highly recommended that the user first runs the raw `character`
vector through the `get_sentences` function.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Create function to count profanity by category</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>count_profanity_by_category <span class="ot">&lt;-</span> <span class="cf">function</span>(book_id, sentence_data) {</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract text for this book</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  book_text <span class="ot">&lt;-</span> sentence_data <span class="sc">|&gt;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(book_id <span class="sc">==</span> <span class="sc">!!</span>book_id) <span class="sc">|&gt;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">" "</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tolower</span>()</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count instances of each category</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  mild_count <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(mild_profanity, <span class="cf">function</span>(term) {</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_count</span>(book_text, <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">b"</span>, term, <span class="st">"</span><span class="sc">\\</span><span class="st">b"</span>))</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  moderate_count <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(moderate_profanity, <span class="cf">function</span>(term) {</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_count</span>(book_text, <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">b"</span>, term, <span class="st">"</span><span class="sc">\\</span><span class="st">b"</span>))</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  strong_count <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(strong_profanity, <span class="cf">function</span>(term) {</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_count</span>(book_text, <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">b"</span>, term, <span class="st">"</span><span class="sc">\\</span><span class="st">b"</span>))</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return counts by category</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">mild =</span> mild_count,</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">moderate =</span> moderate_count,</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">strong =</span> strong_count,</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> mild_count <span class="sc">+</span> moderate_count <span class="sc">+</span> strong_count</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Apply category counting to each book</span></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>book_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(sentence_data<span class="sc">$</span>book_id)</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>category_counts <span class="ot">&lt;-</span> <span class="fu">lapply</span>(book_ids, <span class="cf">function</span>(id) {</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>  counts <span class="ot">&lt;-</span> <span class="fu">count_profanity_by_category</span>(id, sentence_data)</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">book_id =</span> id,</span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">mild_count =</span> counts[<span class="st">"mild"</span>],</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">moderate_count =</span> counts[<span class="st">"moderate"</span>],</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">strong_count =</span> counts[<span class="st">"strong"</span>],</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_count =</span> counts[<span class="st">"total"</span>]</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results</span></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>profanity_categories <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(category_counts) <span class="sc">|&gt;</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join with word counts from profanity_results</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    profanity_results <span class="sc">|&gt;</span> <span class="fu">select</span>(book_id, word_count),</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"book_id"</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate rates per 1000 words</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">mild_per_1000 =</span> (mild_count <span class="sc">/</span> word_count) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">moderate_per_1000 =</span> (moderate_count <span class="sc">/</span> word_count) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">strong_per_1000 =</span> (strong_count <span class="sc">/</span> word_count) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_per_1000 =</span> (total_count <span class="sc">/</span> word_count) <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by total profanity rate</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_per_1000))</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Create visualization of profanity categories</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for stacked bar chart</span></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>profanity_long <span class="ot">&lt;-</span> profanity_categories <span class="sc">|&gt;</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(book_id, <span class="fu">ends_with</span>(<span class="st">"per_1000"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only category columns</span></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>total_per_1000) <span class="sc">|&gt;</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to long format</span></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">ends_with</span>(<span class="st">"per_1000"</span>),</span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"category"</span>,</span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"rate_per_1000"</span></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up category names</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">"mild_per_1000"</span> <span class="sc">~</span> <span class="st">"Mild"</span>,</span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">"moderate_per_1000"</span> <span class="sc">~</span> <span class="st">"Moderate"</span>, </span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">"strong_per_1000"</span> <span class="sc">~</span> <span class="st">"Strong"</span></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to factor with desired order</span></span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">factor</span>(category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Mild"</span>, <span class="st">"Moderate"</span>, <span class="st">"Strong"</span>))</span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Create stacked bar chart</span></span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>category_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(profanity_long, </span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(book_id, rate_per_1000, sum), </span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a>                           <span class="at">y =</span> rate_per_1000,</span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fill =</span> category)) <span class="sc">+</span></span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mild"</span> <span class="ot">=</span> <span class="st">"#FFC107"</span>,</span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Moderate"</span> <span class="ot">=</span> <span class="st">"#FF9800"</span>, </span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Strong"</span> <span class="ot">=</span> <span class="st">"#F44336"</span></span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Profanity in Gaiman's Works by Intensity Level",</span></span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Words per 1,000 categorised by severity"</span>,</span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Book"</span>,</span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Frequency (per 1,000 words)"</span>,</span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Profanity Level"</span></span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Function to extract examples for each category</span></span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a>extract_category_examples <span class="ot">&lt;-</span> <span class="cf">function</span>(book_id, category, word_list, <span class="at">n_examples =</span> <span class="dv">2</span>) {</span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get sentences for this book</span></span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a>  book_sentences <span class="ot">&lt;-</span> sentence_data <span class="sc">|&gt;</span></span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(book_id <span class="sc">==</span> <span class="sc">!!</span>book_id)</span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-115"><a href="#cb46-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find sentences containing words from the specified category</span></span>
<span id="cb46-116"><a href="#cb46-116" aria-hidden="true" tabindex="-1"></a>  matches <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (term <span class="cf">in</span> word_list) {</span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a>    pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">b"</span>, term, <span class="st">"</span><span class="sc">\\</span><span class="st">b"</span>)</span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(book_sentences)) {</span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a>      text <span class="ot">&lt;-</span> book_sentences<span class="sc">$</span>text[i]</span>
<span id="cb46-121"><a href="#cb46-121" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">str_detect</span>(<span class="fu">tolower</span>(text), pattern)) {</span>
<span id="cb46-122"><a href="#cb46-122" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create highlighted text with term in asterisks</span></span>
<span id="cb46-123"><a href="#cb46-123" aria-hidden="true" tabindex="-1"></a>        highlighted <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(</span>
<span id="cb46-124"><a href="#cb46-124" aria-hidden="true" tabindex="-1"></a>          text, </span>
<span id="cb46-125"><a href="#cb46-125" aria-hidden="true" tabindex="-1"></a>          <span class="fu">regex</span>(pattern, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-126"><a href="#cb46-126" aria-hidden="true" tabindex="-1"></a>          <span class="fu">paste0</span>(<span class="st">"**"</span>, term, <span class="st">"**"</span>)</span>
<span id="cb46-127"><a href="#cb46-127" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb46-128"><a href="#cb46-128" aria-hidden="true" tabindex="-1"></a>        matches <span class="ot">&lt;-</span> <span class="fu">c</span>(matches, <span class="fu">list</span>(<span class="fu">list</span>(</span>
<span id="cb46-129"><a href="#cb46-129" aria-hidden="true" tabindex="-1"></a>          <span class="at">sentence_id =</span> book_sentences<span class="sc">$</span>sentence_id[i],</span>
<span id="cb46-130"><a href="#cb46-130" aria-hidden="true" tabindex="-1"></a>          <span class="at">text =</span> highlighted,</span>
<span id="cb46-131"><a href="#cb46-131" aria-hidden="true" tabindex="-1"></a>          <span class="at">term =</span> term</span>
<span id="cb46-132"><a href="#cb46-132" aria-hidden="true" tabindex="-1"></a>        )))</span>
<span id="cb46-133"><a href="#cb46-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stop once have enough examples</span></span>
<span id="cb46-134"><a href="#cb46-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(matches) <span class="sc">&gt;=</span> n_examples) <span class="cf">break</span></span>
<span id="cb46-135"><a href="#cb46-135" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb46-136"><a href="#cb46-136" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb46-137"><a href="#cb46-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lost in the if loops here but dont remove this one!!! </span></span>
<span id="cb46-138"><a href="#cb46-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(matches) <span class="sc">&gt;=</span> n_examples) <span class="cf">break</span></span>
<span id="cb46-139"><a href="#cb46-139" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-140"><a href="#cb46-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-141"><a href="#cb46-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert list to data frame</span></span>
<span id="cb46-142"><a href="#cb46-142" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(matches) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb46-143"><a href="#cb46-143" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(matches, <span class="cf">function</span>(x) {</span>
<span id="cb46-144"><a href="#cb46-144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(</span>
<span id="cb46-145"><a href="#cb46-145" aria-hidden="true" tabindex="-1"></a>        <span class="at">sentence_id =</span> x<span class="sc">$</span>sentence_id,</span>
<span id="cb46-146"><a href="#cb46-146" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> x<span class="sc">$</span>text,</span>
<span id="cb46-147"><a href="#cb46-147" aria-hidden="true" tabindex="-1"></a>        <span class="at">term =</span> x<span class="sc">$</span>term,</span>
<span id="cb46-148"><a href="#cb46-148" aria-hidden="true" tabindex="-1"></a>        <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb46-149"><a href="#cb46-149" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb46-150"><a href="#cb46-150" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb46-151"><a href="#cb46-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">head</span>(result, n_examples))</span>
<span id="cb46-152"><a href="#cb46-152" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb46-153"><a href="#cb46-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb46-154"><a href="#cb46-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">sentence_id =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb46-155"><a href="#cb46-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">text =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb46-156"><a href="#cb46-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">term =</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb46-157"><a href="#cb46-157" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb46-158"><a href="#cb46-158" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-159"><a href="#cb46-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-160"><a href="#cb46-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-161"><a href="#cb46-161" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Extract examples for top books</span></span>
<span id="cb46-162"><a href="#cb46-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Get top 3 books by total profanity</span></span>
<span id="cb46-163"><a href="#cb46-163" aria-hidden="true" tabindex="-1"></a>top_books <span class="ot">&lt;-</span> profanity_categories <span class="sc">|&gt;</span></span>
<span id="cb46-164"><a href="#cb46-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">3</span>, total_per_1000) <span class="sc">|&gt;</span></span>
<span id="cb46-165"><a href="#cb46-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(book_id)</span>
<span id="cb46-166"><a href="#cb46-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-167"><a href="#cb46-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract examples for each category from each top book</span></span>
<span id="cb46-168"><a href="#cb46-168" aria-hidden="true" tabindex="-1"></a>profanity_examples <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb46-169"><a href="#cb46-169" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (book <span class="cf">in</span> top_books) {</span>
<span id="cb46-170"><a href="#cb46-170" aria-hidden="true" tabindex="-1"></a>  profanity_examples[[book]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb46-171"><a href="#cb46-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">mild =</span> <span class="fu">extract_category_examples</span>(book, <span class="st">"Mild"</span>, mild_profanity),</span>
<span id="cb46-172"><a href="#cb46-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">moderate =</span> <span class="fu">extract_category_examples</span>(book, <span class="st">"Moderate"</span>, moderate_profanity),</span>
<span id="cb46-173"><a href="#cb46-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">strong =</span> <span class="fu">extract_category_examples</span>(book, <span class="st">"Strong"</span>, strong_profanity)</span>
<span id="cb46-174"><a href="#cb46-174" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-175"><a href="#cb46-175" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(category_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-swear_analysis" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-swear_analysis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-swear_analysis-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-swear_analysis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Profanity in Gaiman’s Works by Intensity Level
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print category statistics</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Profanity statistics by category and book:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Profanity statistics by category and book:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(profanity_categories <span class="sc">|&gt;</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(book_id, mild_per_1000, moderate_per_1000, strong_per_1000, total_per_1000))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   book_id mild_per_1000 moderate_per_1000 strong_per_1000 total_per_1000
1       AG     0.8468588        0.82088156      0.61306345      2.2808038
2       SM     0.5368665        0.44570051      0.34440494      1.3269720
3       NW     0.5867239        0.28324600      0.15173893      1.0217088
4       AB     0.6024746        0.31472556      0.00000000      0.9172002
5       ST     0.3604717        0.18881851      0.05149596      0.6007862
6      TGB     0.3575312        0.16386849      0.00000000      0.5213997
7      OFG     0.1380929        0.13809294      0.00000000      0.2761859
8    OCEAN     0.1309611        0.11225234      0.00000000      0.2432134
9       CL     0.0972668        0.06484454      0.03242227      0.1945336
10     FTM     0.0000000        0.12975217      0.00000000      0.1297522</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Print examples with category context</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Examples of profanity by category from top books:</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Examples of profanity by category from top books:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (book <span class="cf">in</span> top_books) {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"===== Examples from"</span>, book, <span class="st">"=====</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print mild examples</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">MILD PROFANITY EXAMPLES:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  examples <span class="ot">&lt;-</span> profanity_examples[[book]]<span class="sc">$</span>mild</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(examples) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(examples)) {</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(i, <span class="st">": "</span>, examples<span class="sc">$</span>text[i], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No mild profanity examples found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print moderate examples</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">MODERATE PROFANITY EXAMPLES:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  examples <span class="ot">&lt;-</span> profanity_examples[[book]]<span class="sc">$</span>moderate</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(examples) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(examples)) {</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(i, <span class="st">": "</span>, examples<span class="sc">$</span>text[i], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No moderate profanity examples found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print strong examples</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">STRONG PROFANITY EXAMPLES:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  examples <span class="ot">&lt;-</span> profanity_examples[[book]]<span class="sc">$</span>strong</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(examples) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(examples)) {</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(i, <span class="st">": "</span>, examples<span class="sc">$</span>text[i], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No strong profanity examples found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>===== Examples from AG =====

MILD PROFANITY EXAMPLES:
1 :  "**damn** right. 
2 :  He told her it might not be valid as a driver's license, but it sure as hell was fine identification, and it had a photo of him on it, and his height and his weight, and **damn** it, who else did she think he was, if he wasn't him? 

MODERATE PROFANITY EXAMPLES:
1 :  I tried giving it to my girlfriend in the **ass**, she almost clawed my eyes out." 
2 :  "Kind my **ass**," said the man in the pale suit. 

STRONG PROFANITY EXAMPLES:
1 :  He was big enough, and looked don't-**fuck**-with-me enough that his biggest problem was killing time. 
2 :  "Who the **fuck**'s Herodotus?" 

===== Examples from SM =====

MILD PROFANITY EXAMPLES:
1 :  Someone you'd crawl barefoot into **hell** for. 
2 :  "**hell** no, I'm a landmark. 

MODERATE PROFANITY EXAMPLES:
1 :  "It don't matter a rat's **ass** whether there was anyone with him or not. 
2 :  Revelation retreats to cliché, listen:Things seemed simpler before we kept computers.X.Waking or dreaming from outside I hearwild sabbats, screaming winds, tape hum, metal machine music;witches astride ghetto blasters crowd the moon,then land on the heath their naked flanks aglisten.No one pays anything to attend the meet, each has it taken care of in advance,baby bones with fat still clinging to them;these things are direct debit, standing order,and I seeor think I seea face I recognize and all of them queue up to kiss his **ass**,let's rim the Devil, boys, cold seed,and in the dark he turns and looks at me:One door opens, another one slams,I trust that everything is satisfactory? 

STRONG PROFANITY EXAMPLES:
1 :  "Maybe really I am a drunk with a dog bite on my cheek, and you **fuck** anything that moves and Kevin was never born and- and all that other horrible stuff." 
2 :  I put it into the pocket of my coat and held it in my hand as I walked, its presence warm and reassuring.The river meandered away across the fields, and I walked on in silence.I had walked for an hour before I saw houses-new and small and square-on the embankment above me.And then I saw the bridge, and I knew where I was: I was on the old railway path, and I'd been coming down it from the other direction.There were graffiti painted on the side of the bridge: **fuck** and BARRY LOVES SUSAN and the omnipresent NF of the National Front.I stood beneath the bridge in the red brick arch, stood among the ice cream wrappers, and the crisp packets and the single, sad, used condom, and watched my breath steam in the cold afternoon air.The blood had dried into my trousers.Cars passed over the bridge above me; I could hear a radio playing loudly in one of them." 

===== Examples from NW =====

MILD PROFANITY EXAMPLES:
1 :  "Play it, **damn** you," sobbed Lear. 
2 :  But **damn** it, like all Londoners, he knew his Tube map, and this was going too far. 

MODERATE PROFANITY EXAMPLES:
1 :  I think you're an **asshole**," he said, honestly. 
2 :  "**bastard**," he said, under his breath, and he let go of the rung with his right hand and moved it up eight inches, until it found the next rung. 

STRONG PROFANITY EXAMPLES:
1 :  **fuck** it," announced Richard, and he vaulted the barrier. 
2 :  **fuck** her," said the man." </code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># only show examples for html format </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sentiment-analysis" class="level4" data-number="3.2.0.5">
<h4 data-number="3.2.0.5" class="anchored" data-anchor-id="sentiment-analysis"><span class="header-section-number">3.2.0.5</span> Sentiment Analysis</h4>
<p>I calculated sentence-level sentiment variation by <code>sentimentr</code> <span class="citation" data-cites="tylerw2021">(<a href="#ref-tylerw2021" role="doc-biblioref">Tyler W, 2021</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Calculate sentence-level sentiment</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>sentence_sentiment <span class="ot">&lt;-</span> <span class="fu">sentiment_by</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">text.var =</span> sentence_data<span class="sc">$</span>text,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">list</span>(</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">book_id =</span> sentence_data<span class="sc">$</span>book_id,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sentence_id =</span> sentence_data<span class="sc">$</span>sentence_id</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Each time `sentiment_by` is run it has to do sentence boundary disambiguation when a
raw `character` vector is passed to `text.var`. This may be costly of time and
memory.  It is highly recommended that the user first runs the raw `character`
vector through the `get_sentences` function.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Classify each sentence as positive, negative, or neutral</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>sentence_sentiment <span class="ot">&lt;-</span> sentence_sentiment <span class="sc">|&gt;</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sentiment_class =</span> <span class="fu">case_when</span>(</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>      ave_sentiment <span class="sc">&gt;</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"Positive"</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>      ave_sentiment <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"Negative"</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Neutral"</span>  <span class="co"># Use a small buffer around zero for neutral</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Calculate the distribution for each book</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>book_sentiment_distribution <span class="ot">&lt;-</span> sentence_sentiment <span class="sc">|&gt;</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_sentences =</span> <span class="fu">n</span>(),</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">positive_count =</span> <span class="fu">sum</span>(sentiment_class <span class="sc">==</span> <span class="st">"Positive"</span>),</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">negative_count =</span> <span class="fu">sum</span>(sentiment_class <span class="sc">==</span> <span class="st">"Negative"</span>),</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">neutral_count =</span> <span class="fu">sum</span>(sentiment_class <span class="sc">==</span> <span class="st">"Neutral"</span>),</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">positive_pct =</span> (positive_count <span class="sc">/</span> total_sentences) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">negative_pct =</span> (negative_count <span class="sc">/</span> total_sentences) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">neutral_pct =</span> (neutral_count <span class="sc">/</span> total_sentences) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Verify our percentages add up to 100%</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>book_sentiment_distribution <span class="ot">&lt;-</span> book_sentiment_distribution <span class="sc">|&gt;</span></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_pct =</span> positive_pct <span class="sc">+</span> negative_pct <span class="sc">+</span> neutral_pct)</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results (should be close to 100% for each book)</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(book_sentiment_distribution[, <span class="fu">c</span>(<span class="st">"book_id"</span>, <span class="st">"total_pct"</span>)])</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Create data for visualization</span></span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>sentiment_long <span class="ot">&lt;-</span> book_sentiment_distribution <span class="sc">|&gt;</span></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(book_id, positive_pct, negative_pct, neutral_pct) <span class="sc">|&gt;</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"positive_pct"</span>, <span class="st">"negative_pct"</span>, <span class="st">"neutral_pct"</span>),</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"sentiment"</span>,</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"percentage"</span></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">sentiment =</span> <span class="fu">case_when</span>(</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>      sentiment <span class="sc">==</span> <span class="st">"positive_pct"</span> <span class="sc">~</span> <span class="st">"Positive"</span>,</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>      sentiment <span class="sc">==</span> <span class="st">"negative_pct"</span> <span class="sc">~</span> <span class="st">"Negative"</span>,</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>      sentiment <span class="sc">==</span> <span class="st">"neutral_pct"</span> <span class="sc">~</span> <span class="st">"Neutral"</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Create a simple stacked bar chart</span></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>sentiment_distribution_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sentiment_long, </span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">aes</span>(<span class="at">x =</span> book_id, <span class="at">y =</span> percentage, <span class="at">fill =</span> sentiment)) <span class="sc">+</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"stack"</span>) <span class="sc">+</span></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Positive"</span> <span class="ot">=</span> <span class="st">"#4CAF50"</span>,</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Negative"</span> <span class="ot">=</span> <span class="st">"#F44336"</span>,</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Neutral"</span> <span class="ot">=</span> <span class="st">"#9E9E9E"</span></span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Sentiment Distribution in Gaiman's Works",</span></span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of positive, negative, and neutral sentences in each book"</span>,</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Book"</span>,</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percentage of Sentences"</span>,</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Sentiment"</span></span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure y-axis goes from 0-100%</span></span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>))</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the plot</span></span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sentiment_distribution_plot)</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a summary table for reporting</span></span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a>sentiment_summary <span class="ot">&lt;-</span> book_sentiment_distribution <span class="sc">|&gt;</span></span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(book_id, positive_pct, negative_pct, neutral_pct) <span class="sc">|&gt;</span></span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(positive_pct))</span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sentiment_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-senti_dist" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-senti_dist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-senti_dist-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-senti_dist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Sentiment Distribution in Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sentiment Flow Analysis</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the idea is to show how sentiment changes throughout each book's narrative progression</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Calculate sentiment by chapter for each book</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>chapter_sentiment <span class="ot">&lt;-</span> sentence_sentiment <span class="sc">|&gt;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join with document information to get chapter numbers</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    gaiman_corpus<span class="sc">$</span>sentence_level <span class="sc">|&gt;</span> </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(book_id, sentence_id, chapter_num) <span class="sc">|&gt;</span> </span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(),</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"book_id"</span>, <span class="st">"sentence_id"</span>)</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by book and chapter to calculate average sentiment</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id, chapter_num) <span class="sc">|&gt;</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">chapter_sentiment =</span> <span class="fu">mean</span>(ave_sentiment, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">sentences_count =</span> <span class="fu">n</span>(),</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Calculate normalised position for each chapter within its book</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>normalised_sentiment_flow <span class="ot">&lt;-</span> chapter_sentiment <span class="sc">|&gt;</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by book to calculate relative positions</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the max chapter number for each book</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_chapter =</span> <span class="fu">max</span>(chapter_num, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate normalised position (0-100% of narrative)</span></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">narrative_position =</span> (chapter_num <span class="sc">/</span> max_chapter) <span class="sc">*</span> <span class="dv">100</span> <span class="co"># maybe should change the normalising method, the scaling looks odd</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get book titles for better labeling</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>    gaiman_corpus<span class="sc">$</span>document_level <span class="sc">|&gt;</span> </span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(book_id, title) <span class="sc">|&gt;</span> </span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(),</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"book_id"</span></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make sure we don't have NA values</span></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(chapter_sentiment))</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Create a combined vis showing all books' arcs for report</span></span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>emotional_arcs_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(normalised_sentiment_flow,</span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">aes</span>(<span class="at">x =</span> narrative_position,</span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">y =</span> chapter_sentiment,</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">color =</span> book_id)) <span class="sc">+</span></span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add smoothed trend lines to see the emotional arc</span></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">span =</span> <span class="fl">0.6</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add small points for actual chapter sentiments</span></span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add horizontal reference line at neutral sentiment (0)</span></span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add labels</span></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Emotional Arcs in Neil Gaiman's Works",</span></span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Sentiment progression throughout narrative (0% = beginning, 100% = end)"</span>,</span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Narrative Progression (%)"</span>,</span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Sentiment Score"</span>,</span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Book"</span></span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use a color palette that distinguishes between books</span></span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Paired"</span>) <span class="sc">+</span></span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Create a facetted version showing individual book arcs</span></span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a>individual_arcs_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(normalised_sentiment_flow,</span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">aes</span>(<span class="at">x =</span> narrative_position,</span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">y =</span> chapter_sentiment)) <span class="sc">+</span></span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add smoothed trend lines to see the emotional arc</span></span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">span =</span> <span class="fl">0.6</span>, <span class="fu">aes</span>(<span class="at">color =</span> book_id), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add small points for actual chapter sentiments</span></span>
<span id="cb60-75"><a href="#cb60-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"darkgray"</span>) <span class="sc">+</span></span>
<span id="cb60-76"><a href="#cb60-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add horizontal reference line at neutral sentiment (0)</span></span>
<span id="cb60-77"><a href="#cb60-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb60-78"><a href="#cb60-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Facet by book title for individual arcs</span></span>
<span id="cb60-79"><a href="#cb60-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> title, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb60-80"><a href="#cb60-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add labels</span></span>
<span id="cb60-81"><a href="#cb60-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb60-82"><a href="#cb60-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Individual Emotional Arcs in Neil Gaiman's Works"</span>,</span>
<span id="cb60-83"><a href="#cb60-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Sentiment progression by narrative position for each book"</span>,</span>
<span id="cb60-84"><a href="#cb60-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Narrative Progression (%)"</span>,</span>
<span id="cb60-85"><a href="#cb60-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Sentiment Score"</span></span>
<span id="cb60-86"><a href="#cb60-86" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb60-87"><a href="#cb60-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb60-88"><a href="#cb60-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb60-89"><a href="#cb60-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb60-90"><a href="#cb60-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.spacing =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"lines"</span>),</span>
<span id="cb60-91"><a href="#cb60-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb60-92"><a href="#cb60-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb60-93"><a href="#cb60-93" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-94"><a href="#cb60-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-95"><a href="#cb60-95" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Print both visualizations</span></span>
<span id="cb60-96"><a href="#cb60-96" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emotional_arcs_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(individual_arcs_plot) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Calculate key statistics about the arcs</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>arc_statistics <span class="ot">&lt;-</span> normalised_sentiment_flow <span class="sc">|&gt;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id, title) <span class="sc">|&gt;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_sentiment =</span> <span class="fu">first</span>(chapter_sentiment),</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_sentiment =</span> <span class="fu">last</span>(chapter_sentiment),</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_sentiment =</span> <span class="fu">min</span>(chapter_sentiment),</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_sentiment =</span> <span class="fu">max</span>(chapter_sentiment),</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sentiment_range =</span> max_sentiment <span class="sc">-</span> min_sentiment,</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">overall_trend =</span> end_sentiment <span class="sc">-</span> start_sentiment,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">arc_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>      overall_trend <span class="sc">&gt;</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"Rising (positive resolution)"</span>,</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>      overall_trend <span class="sc">&lt;</span> <span class="sc">-</span><span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"Falling (negative resolution)"</span>,</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Neutral/Circular"</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(overall_trend))</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Print summary statistics</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(arc_statistics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-senti_arc-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-senti_arc-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-senti_arc-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-senti_arc-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Emotional Arcs in Neil Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-senti_arc-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-senti_arc-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-senti_arc-2.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-senti_arc-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Emotional Arcs in Neil Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="discourse-level" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="discourse-level"><span class="header-section-number">3.2.1</span> Discourse level</h3>
<p>After examining word- and sentence-level patterns, this section moves further by exploring discourse-level characteristics in Gaiman’s work. It focuses on how textual elements function together to create meaning across larger units of text. In literature stylistics, discourse features often reveal how authors construct narrative voice, manage perspective, and guide reader engagement – all of which may differ based on intended readership.</p>
<section id="point-of-view-analysis" class="level4" data-number="3.2.1.1">
<h4 data-number="3.2.1.1" class="anchored" data-anchor-id="point-of-view-analysis"><span class="header-section-number">3.2.1.1</span> Point of View analysis</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># POV Stability Analysis (Window-based approach)</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(gaiman_corpus<span class="sc">$</span>token_level)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [728,034 × 8] (S3: tbl_df/tbl/data.frame)
 $ token_id   : chr [1:728034] "AB_ch1_s1_w1" "AB_ch1_s1_w2" "AB_ch1_s1_w3" "AB_ch1_s1_w4" ...
 $ sentence_id: chr [1:728034] "AB_ch1_s1" "AB_ch1_s1" "AB_ch1_s1" "AB_ch1_s1" ...
 $ doc_id     : chr [1:728034] "AB_ch1" "AB_ch1" "AB_ch1" "AB_ch1" ...
 $ book_id    : chr [1:728034] "AB" "AB" "AB" "AB" ...
 $ chapter_num: int [1:728034] 1 1 1 1 1 1 1 1 1 1 ...
 $ position   : int [1:728034] 1 2 3 4 5 6 7 8 9 10 ...
 $ token      : chr [1:728034] "chapter" "onewhich" "is" "mostly" ...
 $ token_lower: chr [1:728034] "chapter" "onewhich" "is" "mostly" ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust the analysis to work with the corpus structure</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this is dis-level anlaysis, but uses token subcorpus </span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>pov_stability <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>token_level <span class="sc">|&gt;</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for pronoun tokens using token_lower instead of upos</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(token_lower <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First person</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"i"</span>, <span class="st">"me"</span>, <span class="st">"my"</span>, <span class="st">"mine"</span>, <span class="st">"myself"</span>, <span class="st">"we"</span>, <span class="st">"us"</span>, <span class="st">"our"</span>, <span class="st">"ours"</span>, <span class="st">"ourselves"</span>,</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second person</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"you"</span>, <span class="st">"your"</span>, <span class="st">"yours"</span>, <span class="st">"yourself"</span>, <span class="st">"yourselves"</span>,</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Third person</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"he"</span>, <span class="st">"him"</span>, <span class="st">"his"</span>, <span class="st">"himself"</span>, <span class="st">"she"</span>, <span class="st">"her"</span>, <span class="st">"hers"</span>, <span class="st">"herself"</span>,</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"it"</span>, <span class="st">"its"</span>, <span class="st">"itself"</span>, <span class="st">"they"</span>, <span class="st">"them"</span>, <span class="st">"their"</span>, <span class="st">"theirs"</span>, <span class="st">"themselves"</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add perspective classification</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">perspective =</span> <span class="fu">case_when</span>(</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>      token_lower <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"i"</span>, <span class="st">"me"</span>, <span class="st">"my"</span>, <span class="st">"mine"</span>, <span class="st">"myself"</span>, <span class="st">"we"</span>, <span class="st">"us"</span>, <span class="st">"our"</span>, <span class="st">"ours"</span>, <span class="st">"ourselves"</span>) <span class="sc">~</span> <span class="st">"first"</span>,</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>      token_lower <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"you"</span>, <span class="st">"your"</span>, <span class="st">"yours"</span>, <span class="st">"yourself"</span>, <span class="st">"yourselves"</span>) <span class="sc">~</span> <span class="st">"second"</span>,</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"third"</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group by book and sentence</span></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id, sentence_id) <span class="sc">|&gt;</span></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine predominant perspective for each sentence</span></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">perspective =</span> <span class="fu">case_when</span>(</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(perspective <span class="sc">==</span> <span class="st">"first"</span>) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"first"</span>,</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(perspective <span class="sc">==</span> <span class="st">"second"</span>) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"second"</span>,</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(perspective <span class="sc">==</span> <span class="st">"third"</span>) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"third"</span>,</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"none"</span>  <span class="co"># Fallback (shouldn't happen given our filter)</span></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Group sentences into windows to avoid name-pronoun alternation issues</span></span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># I dont think this actually words, problem remains</span></span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create perspective windows (groups of consecutive sentences)</span></span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_id =</span> <span class="fu">ceiling</span>(<span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">5</span>)</span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get dominant perspective for each window</span></span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id, window_id) <span class="sc">|&gt;</span></span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">dominant_perspective =</span> <span class="fu">names</span>(<span class="fu">which.max</span>(<span class="fu">table</span>(perspective))),</span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Track shifts in dominant perspective</span></span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb67-49"><a href="#cb67-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb67-50"><a href="#cb67-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">prev_perspective =</span> <span class="fu">lag</span>(dominant_perspective),</span>
<span id="cb67-51"><a href="#cb67-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_shift =</span> dominant_perspective <span class="sc">!=</span> prev_perspective <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(prev_perspective)</span>
<span id="cb67-52"><a href="#cb67-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb67-53"><a href="#cb67-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate stability index and perspective composition</span></span>
<span id="cb67-54"><a href="#cb67-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb67-55"><a href="#cb67-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">windows =</span> <span class="fu">n</span>(),</span>
<span id="cb67-56"><a href="#cb67-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">shifts =</span> <span class="fu">sum</span>(is_shift, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb67-57"><a href="#cb67-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">stability_index =</span> <span class="dv">1</span> <span class="sc">-</span> (shifts <span class="sc">/</span> (windows <span class="sc">-</span> <span class="dv">1</span>)),  <span class="co"># Higher = more stable</span></span>
<span id="cb67-58"><a href="#cb67-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_first =</span> <span class="fu">mean</span>(dominant_perspective <span class="sc">==</span> <span class="st">"first"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb67-59"><a href="#cb67-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_second =</span> <span class="fu">mean</span>(dominant_perspective <span class="sc">==</span> <span class="st">"second"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb67-60"><a href="#cb67-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_third =</span> <span class="fu">mean</span>(dominant_perspective <span class="sc">==</span> <span class="st">"third"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb67-61"><a href="#cb67-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb67-62"><a href="#cb67-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb67-63"><a href="#cb67-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-64"><a href="#cb67-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Get book titles for better vis</span></span>
<span id="cb67-65"><a href="#cb67-65" aria-hidden="true" tabindex="-1"></a>pov_stability <span class="ot">&lt;-</span> pov_stability <span class="sc">|&gt;</span></span>
<span id="cb67-66"><a href="#cb67-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb67-67"><a href="#cb67-67" aria-hidden="true" tabindex="-1"></a>    gaiman_corpus<span class="sc">$</span>document_level <span class="sc">|&gt;</span> </span>
<span id="cb67-68"><a href="#cb67-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(book_id, title) <span class="sc">|&gt;</span> </span>
<span id="cb67-69"><a href="#cb67-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(),</span>
<span id="cb67-70"><a href="#cb67-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"book_id"</span></span>
<span id="cb67-71"><a href="#cb67-71" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-pov_stable" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pov_stable-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-pov_stable-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pov_stable-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Narrative Perspective Stability in Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create perspective composition visualization</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>composition_data <span class="ot">&lt;-</span> pov_stability <span class="sc">|&gt;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(book_id, pct_first, pct_second, pct_third) <span class="sc">|&gt;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(pct_first, pct_second, pct_third),</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"perspective"</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"percentage"</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">perspective =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>      perspective <span class="sc">==</span> <span class="st">"pct_first"</span> <span class="sc">~</span> <span class="st">"First Person"</span>,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>      perspective <span class="sc">==</span> <span class="st">"pct_second"</span> <span class="sc">~</span> <span class="st">"Second Person"</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>      perspective <span class="sc">==</span> <span class="st">"pct_third"</span> <span class="sc">~</span> <span class="st">"Third Person"</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>composition_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(composition_data,</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(book_id, percentage, sum),</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>                              <span class="at">y =</span> percentage,</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>                              <span class="at">fill =</span> perspective)) <span class="sc">+</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"First Person"</span> <span class="ot">=</span> <span class="st">"#E57373"</span>,</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Second Person"</span> <span class="ot">=</span> <span class="st">"#FFB74D"</span>,</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Third Person"</span> <span class="ot">=</span> <span class="st">"#81C784"</span>)) <span class="sc">+</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Narrative Perspective Composition in Gaiman's Works",</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of narrative told in each perspective"</span>,</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Book"</span>,</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percentage"</span>,</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Perspective"</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(composition_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pov_composition" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pov_composition-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-pov_composition-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pov_composition-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Narrative Perspective Composition in Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="modal-verbs-analysis" class="level4" data-number="3.2.1.2">
<h4 data-number="3.2.1.2" class="anchored" data-anchor-id="modal-verbs-analysis"><span class="header-section-number">3.2.1.2</span> Modal verbs analysis</h4>
<p>Based on the framework of modal grammar <span class="citation" data-cites="simpson2003">(<a href="#ref-simpson2003" role="doc-biblioref">Simpson, 2003</a>)</span>, I categorised modal verbs into four functional groups:</p>
<ol type="1">
<li><p><strong>World Building</strong> (must, should, have to, always, never): These establish rules, obligations, and certainties within the narrative world.</p></li>
<li><p><strong>Possibility</strong> (may, might, could, can, maybe): These express uncertainty and potential options.</p></li>
<li><p><strong>Hypothetical</strong> (would, if, whether): These create conditional or speculative scenarios.</p></li>
<li><p><strong>Intent</strong> (will, shall, going to, want to): These signal future actions and determinations.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>book_texts <span class="ot">&lt;-</span> gaiman_corpus<span class="sc">$</span>document_level <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(book_id) <span class="sc">|&gt;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">text =</span> <span class="fu">paste</span>(text, <span class="at">collapse =</span> <span class="st">" "</span>)) <span class="sc">|&gt;</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Corrected function to categorise modal verbs by narrative function</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>analyze_modal_functions <span class="ot">&lt;-</span> <span class="cf">function</span>(text) {</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define patterns for modal categories</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  world_building_pattern <span class="ot">&lt;-</span> <span class="st">"</span><span class="sc">\\</span><span class="st">b(must|should|have to|has to|had to|always|never)</span><span class="sc">\\</span><span class="st">b"</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  possibility_pattern <span class="ot">&lt;-</span> <span class="st">"</span><span class="sc">\\</span><span class="st">b(may|might|could|can|maybe|perhaps)</span><span class="sc">\\</span><span class="st">b"</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  hypothetical_pattern <span class="ot">&lt;-</span> <span class="st">"</span><span class="sc">\\</span><span class="st">b(would|if|whether)</span><span class="sc">\\</span><span class="st">b"</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  intent_pattern <span class="ot">&lt;-</span> <span class="st">"</span><span class="sc">\\</span><span class="st">b(will|shall|going to|want to)</span><span class="sc">\\</span><span class="st">b"</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count matches for each category</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  world_count <span class="ot">&lt;-</span> <span class="fu">str_count</span>(<span class="fu">tolower</span>(text), world_building_pattern)</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  possibility_count <span class="ot">&lt;-</span> <span class="fu">str_count</span>(<span class="fu">tolower</span>(text), possibility_pattern)</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>  hypothetical_count <span class="ot">&lt;-</span> <span class="fu">str_count</span>(<span class="fu">tolower</span>(text), hypothetical_pattern)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  intent_count <span class="ot">&lt;-</span> <span class="fu">str_count</span>(<span class="fu">tolower</span>(text), intent_pattern)</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return named vector of counts</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">world_building =</span> world_count,</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">possibility =</span> possibility_count,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">hypothetical =</span> hypothetical_count,</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">intent =</span> intent_count</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply function to each book</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>modal_results <span class="ot">&lt;-</span> book_texts <span class="sc">|&gt;</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the function to get modal counts</span></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">modal_counts =</span> <span class="fu">list</span>(<span class="fu">analyze_modal_functions</span>(text)),</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract individual counts</span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">world_building =</span> modal_counts[<span class="st">"world_building"</span>],</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">possibility =</span> modal_counts[<span class="st">"possibility"</span>],</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">hypothetical =</span> modal_counts[<span class="st">"hypothetical"</span>],</span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">intent =</span> modal_counts[<span class="st">"intent"</span>],</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get total word count for normalising</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_words =</span> <span class="fu">str_count</span>(text, <span class="st">"</span><span class="sc">\\</span><span class="st">S+"</span>),</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalise per 1000 words</span></span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">world_building_per_k =</span> (world_building <span class="sc">/</span> total_words) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">possibility_per_k =</span> (possibility <span class="sc">/</span> total_words) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">hypothetical_per_k =</span> (hypothetical <span class="sc">/</span> total_words) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">intent_per_k =</span> (intent <span class="sc">/</span> total_words) <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate authority ratio (world_building + intent vs. possibility + hypothetical)</span></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">authority_ratio =</span> (world_building <span class="sc">+</span> intent) <span class="sc">/</span> (possibility <span class="sc">+</span> hypothetical)</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select only needed columns</span></span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(book_id, </span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a>         world_building, possibility, hypothetical, intent, </span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a>         world_building_per_k, possibility_per_k, hypothetical_per_k, intent_per_k,</span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a>         authority_ratio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get book titles for vis</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>modal_results <span class="ot">&lt;-</span> modal_results <span class="sc">|&gt;</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    gaiman_corpus<span class="sc">$</span>document_level <span class="sc">|&gt;</span> </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(book_id, title) <span class="sc">|&gt;</span> </span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(),</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"book_id"</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>modal_long <span class="ot">&lt;-</span> modal_results <span class="sc">|&gt;</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(book_id, title, <span class="fu">ends_with</span>(<span class="st">"_per_k"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">ends_with</span>(<span class="st">"_per_k"</span>),</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"modal_type"</span>,</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"frequency_per_k"</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up category names</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">modal_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>      modal_type <span class="sc">==</span> <span class="st">"world_building_per_k"</span> <span class="sc">~</span> <span class="st">"World Building"</span>,</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>      modal_type <span class="sc">==</span> <span class="st">"possibility_per_k"</span> <span class="sc">~</span> <span class="st">"Possibility"</span>,</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>      modal_type <span class="sc">==</span> <span class="st">"hypothetical_per_k"</span> <span class="sc">~</span> <span class="st">"Hypothetical"</span>,</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>      modal_type <span class="sc">==</span> <span class="st">"intent_per_k"</span> <span class="sc">~</span> <span class="st">"Intent"</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Create improved modal verb usage visualization</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>modal_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(modal_long,</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(book_id, frequency_per_k, sum),</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y =</span> frequency_per_k,</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>                        <span class="at">fill =</span> modal_type)) <span class="sc">+</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"World Building"</span> <span class="ot">=</span> <span class="st">"#5C6BC0"</span>,</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Possibility"</span> <span class="ot">=</span> <span class="st">"#26A69A"</span>,</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Hypothetical"</span> <span class="ot">=</span> <span class="st">"#AB47BC"</span>,</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Intent"</span> <span class="ot">=</span> <span class="st">"#EF5350"</span>)) <span class="sc">+</span></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Modal Verb Usage by Narrative Function"</span>,</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Frequency per 1,000 words across Gaiman's works"</span>,</span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Book"</span>,</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Frequency (per 1,000 words)"</span>,</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Modal Function"</span></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(modal_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-modal_verb" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-modal_verb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-modal_verb-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-modal_verb-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Modal Verb Usage by Narrative Function
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Authority ratio vis</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>authority_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(modal_results,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(book_id, authority_ratio),</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">y =</span> authority_ratio)) <span class="sc">+</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"#FF7043"</span>) <span class="sc">+</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f"</span>, authority_ratio)), </span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Narrative Voice Authority in Gaiman's Works",</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Ratio of authoritative modals (world-building + intent) to uncertain modals (possibility + hypothetical)"</span>,</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Book"</span>,</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Authority Ratio"</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(authority_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-authority" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-authority-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-authority-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-authority-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: Narrative Voice Authority in Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="integrated-analysis" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="integrated-analysis"><span class="header-section-number">3.2.2</span> Integrated Analysis</h3>
<p>The previous sections examined Gaiman’s stylistic variations at multiple linguistic levels. While individual analyses revealed noteworthy patterns, they also highlighted the limitations of single-dimension approaches to categorising works by intended audience. This section integrates findings across lexical, sentence, and discourse levels to develop a more comprehensive understanding of stylistic variation in Gaiman’s works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Compile the features matrix</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract key metrics from previous analyses into a single dataframe</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>gaiman_features <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">book_id =</span> gaiman_corpus<span class="sc">$</span>metadata<span class="sc">$</span>book_level<span class="sc">$</span>book_id,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lexical features</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">lexical_diversity =</span> gaiman_corpus<span class="sc">$</span>metadata<span class="sc">$</span>book_level<span class="sc">$</span>lexical_diversity,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_word_length =</span> word_lengh_stats<span class="sc">$</span>avg_length,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">short_word_pct =</span> word_lengh_stats<span class="sc">$</span>short_word_pct,</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">long_word_pct =</span> word_lengh_stats<span class="sc">$</span>long_word_pct,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sentence features</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_sentence_length =</span> sentence_length_stats<span class="sc">$</span>avg_length,</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">short_sent_pct =</span> sentence_length_stats<span class="sc">$</span>short_sent_pct,</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">long_sent_pct =</span> sentence_length_stats<span class="sc">$</span>long_sent_pct,</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_dep_length =</span> book_dependency_stats<span class="sc">$</span>mean_dep_length,</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">readability_score =</span> readability_data<span class="sc">$</span>Flesch.Kincaid,</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sentiment and profanity</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">positive_sentiment =</span> book_sentiment_distribution<span class="sc">$</span>positive_pct,</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">negative_sentiment =</span> book_sentiment_distribution<span class="sc">$</span>negative_pct,</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">total_profanity =</span> profanity_categories<span class="sc">$</span>total_per_1000,</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">strong_profanity =</span> profanity_categories<span class="sc">$</span>strong_per_1000,</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Discourse features</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">first_person_pct =</span> pov_stability<span class="sc">$</span>pct_first,</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">third_person_pct =</span> pov_stability<span class="sc">$</span>pct_third,</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">pov_stability =</span> pov_stability<span class="sc">$</span>stability_index,</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">authority_ratio =</span> modal_results<span class="sc">$</span>authority_ratio</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Set book_id as rownames and remove from data matrix</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(gaiman_features) <span class="ot">&lt;-</span> gaiman_features<span class="sc">$</span>book_id</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>gaiman_features <span class="ot">&lt;-</span> gaiman_features <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>book_id)</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Run the PCA</span></span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a><span class="co"># scale=TRUE ensures all features are standardized before PCA</span></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>gaiman_pca <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(gaiman_features, <span class="at">scale =</span> <span class="cn">TRUE</span>)</span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Examine basic PCA results</span></span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------</span></span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance explained by each principal component</span></span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gaiman_pca) </span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the feature loadings on principal components</span></span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>loadings <span class="ot">&lt;-</span> gaiman_pca<span class="sc">$</span>rotation</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a><span class="co"># print(loadings[, 1:2])  # Loadings on first two components -- no show for final report </span></span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Create a clear, informative visualization</span></span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>book_scores <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(gaiman_pca<span class="sc">$</span>x)</span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>book_scores<span class="sc">$</span>book_id <span class="ot">&lt;-</span> <span class="fu">rownames</span>(book_scores)</span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Join with book titles for clearer labeling</span></span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a>book_scores <span class="ot">&lt;-</span> book_scores <span class="sc">|&gt;</span></span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>    gaiman_corpus<span class="sc">$</span>document_level <span class="sc">|&gt;</span></span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(book_id, title) <span class="sc">|&gt;</span></span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(),</span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"book_id"</span></span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-64"><a href="#cb72-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-65"><a href="#cb72-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract feature loadings for arrows</span></span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a>loadings_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(gaiman_pca<span class="sc">$</span>rotation[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a>loadings_df<span class="sc">$</span>feature <span class="ot">&lt;-</span> <span class="fu">rownames</span>(loadings_df)</span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the enhanced biplot</span></span>
<span id="cb72-70"><a href="#cb72-70" aria-hidden="true" tabindex="-1"></a>pca_spectrum <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb72-71"><a href="#cb72-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add feature vectors as arrows</span></span>
<span id="cb72-72"><a href="#cb72-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">data =</span> loadings_df,</span>
<span id="cb72-73"><a href="#cb72-73" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">xend =</span> PC1<span class="sc">*</span><span class="dv">5</span>, <span class="at">yend =</span> PC2<span class="sc">*</span><span class="dv">5</span>),</span>
<span id="cb72-74"><a href="#cb72-74" aria-hidden="true" tabindex="-1"></a>               <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>)),</span>
<span id="cb72-75"><a href="#cb72-75" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb72-76"><a href="#cb72-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add feature labels</span></span>
<span id="cb72-77"><a href="#cb72-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data =</span> loadings_df,</span>
<span id="cb72-78"><a href="#cb72-78" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">x =</span> PC1<span class="sc">*</span><span class="fl">5.5</span>, <span class="at">y =</span> PC2<span class="sc">*</span><span class="fl">5.5</span>, <span class="at">label =</span> feature),</span>
<span id="cb72-79"><a href="#cb72-79" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb72-80"><a href="#cb72-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add book points</span></span>
<span id="cb72-81"><a href="#cb72-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> book_scores, </span>
<span id="cb72-82"><a href="#cb72-82" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2),</span>
<span id="cb72-83"><a href="#cb72-83" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"darkred"</span>) <span class="sc">+</span></span>
<span id="cb72-84"><a href="#cb72-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add book labels</span></span>
<span id="cb72-85"><a href="#cb72-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data =</span> book_scores,</span>
<span id="cb72-86"><a href="#cb72-86" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">label =</span> book_id),</span>
<span id="cb72-87"><a href="#cb72-87" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">4</span>, </span>
<span id="cb72-88"><a href="#cb72-88" aria-hidden="true" tabindex="-1"></a>                  <span class="at">box.padding =</span> <span class="fl">0.5</span>,</span>
<span id="cb72-89"><a href="#cb72-89" aria-hidden="true" tabindex="-1"></a>                  <span class="at">point.padding =</span> <span class="fl">0.3</span>,</span>
<span id="cb72-90"><a href="#cb72-90" aria-hidden="true" tabindex="-1"></a>                  <span class="at">force =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb72-91"><a href="#cb72-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add interpretive annotations</span></span>
<span id="cb72-92"><a href="#cb72-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">max</span>(book_scores<span class="sc">$</span>PC1)<span class="sc">*</span><span class="fl">0.85</span>, <span class="at">y =</span> <span class="dv">0</span>, </span>
<span id="cb72-93"><a href="#cb72-93" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"More complex, advanced"</span>, </span>
<span id="cb72-94"><a href="#cb72-94" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb72-95"><a href="#cb72-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">min</span>(book_scores<span class="sc">$</span>PC1)<span class="sc">*</span><span class="fl">0.85</span>, <span class="at">y =</span> <span class="dv">0</span>, </span>
<span id="cb72-96"><a href="#cb72-96" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"Simpler, more accessible"</span>, </span>
<span id="cb72-97"><a href="#cb72-97" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb72-98"><a href="#cb72-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add titles and axis labels with percentage of variance explained</span></span>
<span id="cb72-99"><a href="#cb72-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb72-100"><a href="#cb72-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">#title = "Linguistic Spectrum of Gaiman's Works",</span></span>
<span id="cb72-101"><a href="#cb72-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Books positioned by linguistic similarities"</span>,</span>
<span id="cb72-102"><a href="#cb72-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"Linguistic Complexity (PC1: "</span>, <span class="fu">round</span>(gaiman_pca<span class="sc">$</span>sdev[<span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="fu">sum</span>(gaiman_pca<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%)"</span>),</span>
<span id="cb72-103"><a href="#cb72-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">paste0</span>(<span class="st">"Narrative Perspective (PC2: "</span>, <span class="fu">round</span>(gaiman_pca<span class="sc">$</span>sdev[<span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="fu">sum</span>(gaiman_pca<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%)"</span>)</span>
<span id="cb72-104"><a href="#cb72-104" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb72-105"><a href="#cb72-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visual enhancements</span></span>
<span id="cb72-106"><a href="#cb72-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb72-107"><a href="#cb72-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb72-108"><a href="#cb72-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb72-109"><a href="#cb72-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"italic"</span>),</span>
<span id="cb72-110"><a href="#cb72-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb72-111"><a href="#cb72-111" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb72-112"><a href="#cb72-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add reference lines at origin</span></span>
<span id="cb72-113"><a href="#cb72-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb72-114"><a href="#cb72-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>)</span>
<span id="cb72-115"><a href="#cb72-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-116"><a href="#cb72-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the vis</span></span>
<span id="cb72-117"><a href="#cb72-117" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pca_spectrum)</span>
<span id="cb72-118"><a href="#cb72-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-119"><a href="#cb72-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-120"><a href="#cb72-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Identify key differentiating features</span></span>
<span id="cb72-121"><a href="#cb72-121" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------</span></span>
<span id="cb72-122"><a href="#cb72-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate feature contribution to first two principal components</span></span>
<span id="cb72-123"><a href="#cb72-123" aria-hidden="true" tabindex="-1"></a>feature_contrib <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb72-124"><a href="#cb72-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature =</span> <span class="fu">colnames</span>(gaiman_features),</span>
<span id="cb72-125"><a href="#cb72-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC1_contribution =</span> <span class="fu">abs</span>(loadings[, <span class="dv">1</span>]),</span>
<span id="cb72-126"><a href="#cb72-126" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC2_contribution =</span> <span class="fu">abs</span>(loadings[, <span class="dv">2</span>])</span>
<span id="cb72-127"><a href="#cb72-127" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb72-128"><a href="#cb72-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(PC1_contribution))</span>
<span id="cb72-129"><a href="#cb72-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-130"><a href="#cb72-130" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(feature_contrib)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pca_feature_selection" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pca_feature_selection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="final_project_web_files/figure-html/fig-pca_feature_selection-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pca_feature_selection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15: Linguistic Spectrum of Gaiman’s Works
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="sec-reference" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Reference</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-benoit2018" class="csl-entry" role="listitem">
Benoit, K., Watanabe, K., Wang, H., Nulty, P., Obeng, A., Müller, S., &amp; Matsuo, A. (2018). Quanteda: An r package for the quantitative analysis of textual data. <em>Journal of Open Source Software</em>, <em>3</em>(30), 774. <a href="https://doi.org/10.21105/joss.00774">https://doi.org/10.21105/joss.00774</a>
</div>
<div id="ref-haitaoliu2008" class="csl-entry" role="listitem">
Haitao Liu. (2008). Dependency distance as a metric of language comprehension difficulty. <em>Journal of Cognitive Science</em>, <em>9</em>(2), 159–191. <a href="https://doi.org/10.17791/JCS.2008.9.2.159">https://doi.org/10.17791/JCS.2008.9.2.159</a>
</div>
<div id="ref-leonawicz2025" class="csl-entry" role="listitem">
Leonawicz, M. (2025). <em>Epubr: Read EPUB file metadata and text</em>. <a href="https://docs.ropensci.org/epubr/">https://docs.ropensci.org/epubr/</a>
</div>
<div id="ref-mullen" class="csl-entry" role="listitem">
Mullen, L. (n.d.). <em>tokenizers: Fast, Consistent Tokenization of Natural Language Text</em>. <a href="https://doi.org/10.32614/CRAN.package.tokenizers">https://doi.org/10.32614/CRAN.package.tokenizers</a>
</div>
<div id="ref-simpson2003" class="csl-entry" role="listitem">
Simpson, P. (2003). <em>Language, Ideology and Point of View</em> (0th ed.). Routledge. <a href="https://doi.org/10.4324/9780203136867">https://doi.org/10.4324/9780203136867</a>
</div>
<div id="ref-straka2016" class="csl-entry" role="listitem">
Straka, M., Hajič, J., &amp; Straková, J. (2016). <em>LREC 2016</em> (N. Calzolari, K. Choukri, T. Declerck, S. Goggi, M. Grobelnik, B. Maegaard, J. Mariani, H. Mazo, A. Moreno, J. Odijk, &amp; S. Piperidis, Eds.; p. 42904297). European Language Resources Association (ELRA). <a href="https://aclanthology.org/L16-1680/">https://aclanthology.org/L16-1680/</a>
</div>
<div id="ref-tylerw2021" class="csl-entry" role="listitem">
Tyler W, R. (2021). <em><span></span>Sentimentr<span></span>: Calculate text polarity sentiment</em>. <a href="https://github.com/trinker/sentimentr">https://github.com/trinker/sentimentr</a>
</div>
</div>
</section>
<section id="section" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> </h1>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>